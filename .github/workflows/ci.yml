name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  required-check:
    name: required-check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate merge conflict markers
        run: |
          if git grep -n -E '^(<<<<<<< |>>>>>>> )' -- .; then
            echo "Merge conflict markers found in tracked files."
            exit 1
          fi

      - name: Validate forbidden secret-like files are not tracked
        run: |
          tracked_env=$(git ls-files | grep -E '(^|/)\.env($|\.)' | grep -Ev '(^|/)\.env\.example$' || true)
          tracked_keys=$(git ls-files | grep -E '(^|/)(id_rsa|id_dsa|id_ed25519|.*\.pem)$' || true)

          if [ -n "$tracked_env" ] || [ -n "$tracked_keys" ]; then
            echo "$tracked_env"
            echo "$tracked_keys"
            echo "Forbidden secret-like files are tracked by git."
            exit 1
          fi

      - name: Validate collaboration templates are present
        run: |
          test -f .github/PULL_REQUEST_TEMPLATE.md
          test -f .github/ISSUE_TEMPLATE/bug_report.md
          test -f .github/ISSUE_TEMPLATE/feature_request.md

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Run test suite (O1/O2/O3 + runtime)
        run: npm test

      - name: Run runtime smoke test
        run: npm run smoke:runtime
